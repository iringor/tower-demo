---
# Red Hat Insights has recommended one or more actions for you, a system administrator, to review and if you
# deem appropriate, deploy on your systems running Red Hat software. Based on the analysis, we have automatically
# generated an Ansible Playbook for you. Please review and test the recommended actions and the Playbook as
# they may contain configuration changes, updates, reboots and/or other changes to your systems. Red Hat is not
# responsible for any adverse outcomes related to these recommendations or Playbooks.
#
# insight-nfssecurity
# https://console.redhat.com/insights/remediations/89637068-5c90-4472-8cec-c753e92b66f5
# Generated by Red Hat Insights on Thu, 28 Mar 2024 22:55:10 GMT
# Created by isauroringor

# Decreased security: NFS server settings
# Identifier: (advisor:hardening_nfs|NFS_HARDENING,fix)
# Version: 9788a2d4ce207e3a7d0208e1627e79969b1f052f
- name: Remove no_root_squash from all NFS exports files
  hosts: tstecsb2
  become: true
  vars:
    insights_signature_exclude: /hosts,/vars/insights_signature
    insights_signature: !!binary |
      TFMwdExTMUNSVWRKVGlCUVIxQWdVMGxIVGtGVVZWSkZMUzB0TFMwS1ZtVnljMmx2YmpvZ1IyNTFV
      RWNnZGpFS0NtbFJTVlpCZDFWQldVc3dkM1JOZG5jMU9FUXJhalZ3VGtGUloyWmFRa0ZCYTBGTWVW
      WkhaMjVvWW5sMlV6UTVSMlYyYkVGMU1VNVlZblkwTDNwQ1Myb0thbkpFWVc5blZXZDBaVmN3VlU5
      clVHRXZlbHB6VjNRNFJIcGtSVkpwTm5acFFUa3plWFZ5VG5sa1N6Z3hObklyYkZRMFZXdHNhVU5C
      U1RGRVZITk9hZ292UW5BNGRGZEhaa2hrTkZaa2JsaFpSV0pPUldGVlIwUmhSelpJTjNSRlluZGtO
      VmgyUm5KUmFWTm1LMkZSTW5ka1FsSlFTVUZCSzJZM2NGbEVXV3RMQ210RlEwY3ZObU5uVERZek9H
      SlZaMEZxV1dSTWMwNTZOQzlhU0VkNWNYUTRjeXQyZVVWSWJXdExhemhTVldGV1NIVkVRM0poZW5S
      aE9IVjBUbWg0UzJvS05XTTNhbXhLVDFSclkxTmlZMDFIUm1wcUwwczRLMlpGZURoVU5FWnFVMVps
      WkZrNU9IcEpTVU5ZTUVsNVNqTXhXVVZWZW1GbFZsRXZRek5wU0hOR1NBcDNRakZqTjB3elNuSkNM
      ekE0TDIxSFVsRkJNblZJVDNNNGVsWXhNV2cwWVhCWlIySlZPVzEyYWpsNU1qQjRSVVpYU0RnMlUx
      ZEdaRWxCUkZWQldpOWtDbXR3ZUdOUk5HVlZRaTk1VWxacFJYcFVWVmx3ZUU1TmRTdFFUbU5ZUkZZ
      eFpYWjVibVZ4VUhWNlJGWlFUVFpQY1RKbFpFTkZibUU1ZURoTk5EWndjVVVLY2xoUFZFTlBZekZ2
      VDBWdlNXeG5LME4yV204d1VuUldabk5YZVZKYVVqaHVOSEUxTVRoSlZrcHBVbmhCV0RZNWRURlZl
      RkpqUzNkS05XZ3lORlZ2TkFwVFlsZEllRTV3VTBZd1psRnRhQ3RpUmtWbVZFaEdha3hRVlRWb1ZX
      TmhNMVoyYTFWRFJVOWlXVXMyVVUxdU0xRjNSazlxVVRsNllrbEJRMnhFVTNkQ0NrcGtMMFpTVTJa
      blZUWlNkMDV4UzNrck1GSjVlVzlqYTA1UVlXRlRiakUxVTBnNFRGVktNVkJKV21kaWRGWmhjbEpr
      YXpKMk5HRkNMM2hMVTI5VWFrZ0tVREJoVkRCb1owWkhXV0kyVHpacGJHMDJZWGRJTTFCNmR6VTNT
      REJGWm5VM1UxQnZTak5XZFN0dFVtdFZORUZrT0dsbk9IZHFOV0Z3YVVOTVoxWlBlQXA1ZVdoUkx6
      RjJlVGhpVVQwS1BUSXZiMVVLTFMwdExTMUZUa1FnVUVkUUlGTkpSMDVCVkZWU1JTMHRMUzB0Q2c9
      PQ==
  tasks:
    - name: Get list of exports files containing no_root_squash
      shell: grep -l "^\s*[^#].*no_root_squash" /etc/exports /etc/exports.d/*
      register: grep
      ignore_errors: true
      check_mode: no
      changed_when: false

    - name: Fix when no_root_squash is the first option
      replace:
        backup: yes
        dest: "{{ item }}"
        regexp: '\(no_root_squash,'
        replace: '('
      with_items: "{{ grep.stdout_lines }}"

    - name: Fix when no_root_squash is elsewhere in the option list
      replace:
        backup: yes
        dest: "{{ item }}"
        regexp: ',*no_root_squash'
        replace: ''
      with_items: "{{ grep.stdout_lines }}"


- name: run insights
  hosts: tstecsb2
  become: true
  gather_facts: false
  vars:
    insights_signature_exclude: /hosts,/vars/insights_signature
    insights_signature: !!binary |
      TFMwdExTMUNSVWRKVGlCUVIxQWdVMGxIVGtGVVZWSkZMUzB0TFMwS1ZtVnljMmx2YmpvZ1IyNTFV
      RWNnZGpFS0NtbFJTVlpCZDFWQldVaHBRaXR6ZG5jMU9FUXJhalZ3VGtGUmFXdDRaeTh2WmtaRFoz
      QXlTblIxVEd0UU5qQnNTa3BZYm1GU1JGTjVjVVYwU0ZSNlRGY0tOVlZSVlc5MWEyUmpVRFJVUlZn
      d01EaDFhRkJHUzFaSmVrdFVTR2RsYTFOaU1UUXlkMjlQYm5sR2VUUnpRbEJrZEZoaGREVlliWEp0
      VGxsR1EwaEVWZ28xYVhSdlNrcDBPVzg1UWtkQlJVaDVZMFJ3SzBoNVNqWXphM0paZVRGUk1rOXVU
      azF3VjJaSmNtYzJUakJXVTJoa1JtVk1lR0ppTjBaMlpFaEpjbFo2Q2pJNGFrdHhOemx1Tm13eUx6
      aDZZVkJSTDFkWVZIWkNaMDVhUkVWTFJ6TmhSSFl3WVRkbWIyUnlPRWhEZGxseE5tNUhNRkZOY1RO
      U1ZFOXBkbFZtTTFnS1JuQnlhVTh2TDNKSlRDOVlSelE1TTA1NGFWSjBRakVyZEhSUk0wZHNhM1ZE
      ZFVwck1EQkdaREp0ZDNZNFprRnZaR2xUUW5aelQydEpZekZyV25adFN3cEJjR3BEY1ZKMWVHaExU
      MDgzYWxZM1FYSnRTV0p6TkhobVJrUkJVMkZaV2t4R01VMHZhME42ZWs1d1MwTjFhbE5hVUUxRlVt
      WlhhV2RHVGpGMWRqRjNDalpQSzB0b1pTdFJVRU5hUm5CV1kwVndSbTFSTVdwcWFrOVFPV2haSzNW
      alZWSnhSVEkyTlhGTWRuWnFSWE4wUW5WQk4xQkZNRVZ3UkRsaU5VaFZSM1lLTkZKemJXc3pNbFpC
      Vnl0WE5IWk1VRWQwZG1sQ00wSXpUbE0wZUhCdVIzSmlObGs1Y1cwNFZuVTJSRUZIV2xOYWRsbFlk
      bWQwTm1WR2N6RTVTVFZZUWdvMGVtcFVSRUlyTW1sT2NrcE9jM2d5YURoU1VGVnJMMmhZUzFKMGEy
      WnZZMlpKZVRkcGNWY3hiMGRsTlZSMmFqTTFSbXRqUld0YU9VRnpSMjl6WXpWMENuUlZkVlZJWWpS
      ME5EVTFSSE5EWlZWc1ZEZFNOakJDTTB4d1Z6TmlTRTF0YzFCMEx6RktNRFEwYm1KS2RFTkhUM1Jy
      UVVWWVRsVTJlbGxUTDNBMFFqSUtaSFYxY2tZdlNHUnFWWFJNVDNSdlNFTnlZVWd2WkZwaFRVNTZk
      MVZpZUc1VFZXUkdZU3R6TTBaNFJHczFVVkU0VVRaMVVucFpRbWw0WkcxeWREZGpUQXBKYTA1NlEy
      aHBRMDlrY3owS1BVMVZOMk1LTFMwdExTMUZUa1FnVUVkUUlGTkpSMDVCVkZWU1JTMHRMUzB0Q2c9
      PQ==
  tasks:
    - name: run insights
      command: insights-client
      changed_when: false